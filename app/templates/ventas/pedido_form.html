{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2><i class="fas fa-plus-circle"></i> Nuevo Pedido</h2>
        <p class="text-muted">Agrega uno o varios pedidos para un cliente</p>
    </div>
    <div class="col-auto">
        <a href="{{ url_for('ventas.dashboard') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Volver
        </a>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-shopping-cart"></i> Información del Pedido</h5>
            </div>
            <div class="card-body">
                <form method="POST" id="form-pedidos">
                    {{ form.hidden_tag() }}
                    
                    <!-- Selección de Cliente -->
                    <div class="mb-4 p-3 bg-light rounded">
                        <div class="mb-3">
                            {{ form.cliente_id.label(class="form-label fw-bold") }}
                            {{ form.cliente_id(class="form-select" + (" is-invalid" if form.cliente_id.errors else ""), id="select-cliente") }}
                            {% if form.cliente_id.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.cliente_id.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i>
                                Selecciona el cliente para quien harás los pedidos
                            </small>
                        </div>
                        
                        <!-- Información del cliente seleccionado -->
                        <div id="info-cliente" style="display: none;" class="mt-3 p-3 border rounded bg-white">
                            <h6 class="text-primary"><i class="fas fa-user"></i> Datos del Cliente</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <small class="text-muted">Nombre:</small>
                                    <p class="mb-1" id="cliente-nombre"></p>
                                </div>
                                <div class="col-md-4">
                                    <small class="text-muted">Teléfono:</small>
                                    <p class="mb-1" id="cliente-telefono"></p>
                                </div>
                                <div class="col-md-4">
                                    <small class="text-muted">Ruta:</small>
                                    <p class="mb-1" id="cliente-ruta"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <!-- Lista de Pedidos -->
                    <div id="lista-pedidos">
                        <h5 class="mb-3"><i class="fas fa-list"></i> Pedidos a Cargar</h5>
                        
                        <!-- Pedido 1 (plantilla inicial) -->
                        <div class="pedido-item mb-3 p-3 border rounded" data-pedido-num="1">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0 text-primary">
                                    <i class="fas fa-box"></i> Pedido #<span class="pedido-numero">1</span>
                                </h6>
                                <button type="button" class="btn btn-sm btn-danger btn-eliminar-pedido" onclick="eliminarPedido(1)" style="display: none;">
                                    <i class="fas fa-trash"></i> Eliminar
                                </button>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-5">
                                    <div class="mb-3">
                                        <label class="form-label">Producto *</label>
                                        <input type="text" 
                                               name="productos[]" 
                                               class="form-control input-producto" 
                                               placeholder="Ej: Pan lactal" 
                                               required>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">Cantidad *</label>
                                        <input type="number" 
                                               name="cantidades[]" 
                                               class="form-control input-cantidad" 
                                               placeholder="100" 
                                               step="0.01"
                                               min="0.01"
                                               required>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Unidad</label>
                                        <select name="unidades[]" class="form-select input-unidad">
                                            <option value="unidades">Unidades</option>
                                            <option value="kg">Kilogramos (kg)</option>
                                            <option value="docenas">Docenas</option>
                                            <option value="cajas">Cajas</option>
                                            <option value="bolsas">Bolsas</option>
                                            <option value="litros">Litros</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-12">
                                    <div class="mb-0">
                                        <label class="form-label">Notas del Pedido (Opcional)</label>
                                        <textarea name="notas[]" 
                                                  class="form-control input-notas" 
                                                  rows="2" 
                                                  placeholder="Observaciones, detalles especiales..."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Botón para agregar más pedidos -->
                    <div class="mb-4">
                        <button type="button" class="btn btn-outline-primary" onclick="agregarOtroPedido()">
                            <i class="fas fa-plus"></i> Agregar Otro Pedido al Mismo Cliente
                        </button>
                    </div>
                    
                    <hr>
                    
                    <!-- Botones de acción -->
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('ventas.dashboard') }}" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Cancelar
                        </a>
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="fas fa-save"></i> Guardar Pedido(s)
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Panel lateral con resumen -->
    <div class="col-lg-4">
        <div class="card sticky-top" style="top: 20px;">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-clipboard-list"></i> Resumen</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <small class="text-muted">Cliente Seleccionado:</small>
                    <p class="fw-bold mb-0" id="resumen-cliente">Ninguno</p>
                </div>
                <div class="mb-3">
                    <small class="text-muted">Total de Pedidos:</small>
                    <h3 class="mb-0 text-primary" id="resumen-total">0</h3>
                </div>
                <hr>
                <div class="alert alert-info mb-0">
                    <i class="fas fa-lightbulb"></i>
                    <small>
                        <strong>Consejo:</strong> Puedes agregar varios pedidos para el mismo cliente de una sola vez.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let contadorPedidos = 1;

// Mostrar info del cliente al seleccionar
document.getElementById('select-cliente').addEventListener('change', function() {
    const clienteId = this.value;
    const infoDiv = document.getElementById('info-cliente');
    
    if (clienteId) {
        // Obtener info del cliente (del option seleccionado)
        const selectedOption = this.options[this.selectedIndex];
        const clienteNombre = selectedOption.text.split(' - ')[0];
        
        // Hacer request para obtener más detalles
        fetch(`/ventas/api/cliente/${clienteId}/info`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('cliente-nombre').textContent = data.nombre;
                document.getElementById('cliente-telefono').textContent = data.telefono || 'No especificado';
                document.getElementById('cliente-ruta').innerHTML = `<span class="badge bg-info">${data.ruta}</span>`;
                document.getElementById('resumen-cliente').textContent = data.nombre;
                infoDiv.style.display = 'block';
            });
    } else {
        infoDiv.style.display = 'none';
        document.getElementById('resumen-cliente').textContent = 'Ninguno';
    }
    
    actualizarResumen();
});

function agregarOtroPedido() {
    contadorPedidos++;
    
    const plantilla = `
        <div class="pedido-item mb-3 p-3 border rounded" data-pedido-num="${contadorPedidos}">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0 text-primary">
                    <i class="fas fa-box"></i> Pedido #<span class="pedido-numero">${contadorPedidos}</span>
                </h6>
                <button type="button" class="btn btn-sm btn-danger btn-eliminar-pedido" onclick="eliminarPedido(${contadorPedidos})">
                    <i class="fas fa-trash"></i> Eliminar
                </button>
            </div>
            
            <div class="row">
                <div class="col-md-5">
                    <div class="mb-3">
                        <label class="form-label">Producto *</label>
                        <input type="text" 
                               name="productos[]" 
                               class="form-control input-producto" 
                               placeholder="Ej: Pan lactal" 
                               required>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <label class="form-label">Cantidad *</label>
                        <input type="number" 
                               name="cantidades[]" 
                               class="form-control input-cantidad" 
                               placeholder="100" 
                               step="0.01"
                               min="0.01"
                               required>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label">Unidad</label>
                        <select name="unidades[]" class="form-select input-unidad">
                            <option value="unidades">Unidades</option>
                            <option value="kg">Kilogramos (kg)</option>
                            <option value="docenas">Docenas</option>
                            <option value="cajas">Cajas</option>
                            <option value="bolsas">Bolsas</option>
                            <option value="litros">Litros</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-12">
                    <div class="mb-0">
                        <label class="form-label">Notas del Pedido (Opcional)</label>
                        <textarea name="notas[]" 
                                  class="form-control input-notas" 
                                  rows="2" 
                                  placeholder="Observaciones, detalles especiales..."></textarea>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('lista-pedidos').insertAdjacentHTML('beforeend', plantilla);
    
    // Mostrar botón eliminar en el primer pedido si hay más de uno
    if (contadorPedidos > 1) {
        document.querySelector('[data-pedido-num="1"] .btn-eliminar-pedido').style.display = 'inline-block';
    }
    
    actualizarResumen();
}

function eliminarPedido(num) {
    const pedidoDiv = document.querySelector(`[data-pedido-num="${num}"]`);
    if (pedidoDiv) {
        pedidoDiv.remove();
        contadorPedidos--;
        
        // Renumerar pedidos
        const pedidos = document.querySelectorAll('.pedido-item');
        pedidos.forEach((pedido, index) => {
            pedido.setAttribute('data-pedido-num', index + 1);
            pedido.querySelector('.pedido-numero').textContent = index + 1;
            const btnEliminar = pedido.querySelector('.btn-eliminar-pedido');
            btnEliminar.setAttribute('onclick', `eliminarPedido(${index + 1})`);
            
            // Ocultar botón eliminar del primero si solo queda uno
            if (index === 0 && pedidos.length === 1) {
                btnEliminar.style.display = 'none';
            }
        });
        
        contadorPedidos = pedidos.length;
        actualizarResumen();
    }
}

function actualizarResumen() {
    const totalPedidos = document.querySelectorAll('.pedido-item').length;
    document.getElementById('resumen-total').textContent = totalPedidos;
}

// Actualizar resumen inicial
actualizarResumen();
</script>
{% endblock %}